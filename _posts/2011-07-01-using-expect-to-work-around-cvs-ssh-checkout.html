---
layout: post
title:  "Using Expect to Work Around CVS SSH Checkout"
date:   2011-07-01 03:57:00 -0500
---

    <p>Pragmatic Programmer Stuart Holloway said in a <a href="http://twitter.com/stuarthalloway/status/86192542735011840">tweet</a>
 recently, “Anybody can be agile in a green field. Show me your 3rd, 
4th, and 5th releases.” Well, we've been maintaining Oracle Mojarra JSF 
for <a href="http://jsf.java.net/downloads/">32 releases</a>
 and, we’ve found hudson a completely invaluable tool for maintaining 
agility as the technology matures and requires maintenance across all 
the versions we've ever released.  Unfortunately, project hygiene has 
been difficult to maintain across all the code lines, and the JSF 1.2 
branch hasn't had a working hudson job in several years. This blog entry
 shares a little tip I uncovered while re-activing the Mojarra JSF 1.2 
job.</p>  <p>Mojarra JSF 1.2 is maintained in <a href="http://javaserverfaces.java.net/checkout.html#cvs">CVS</a>
 because it is not economically viable to move it to a more recent 
version control system.  As such, it must use CVS_RSH.  More recent 
versions of hudson have support for this, but for some reason I haven't 
been able to get it working with the java.net cvs server.  I used a 
combination of perl and expect to get the checkout working.</p>  <p>I had to download and install expectperl from &lt;<a href="http://sourceforge.net/projects/expectperl/">http://sourceforge.net/projects/expectperl/</a>&gt; and the IO::Tty perl module from &lt;<a href="http://search.cpan.org/%7Etoddr/IO-Tty/Tty.pm">http://search.cpan.org/~toddr/IO-Tty/Tty.pm</a>&gt;  This little perl script successfully does the cvs update, even with the ssh password prompting.</p>  <div class="perl" style="font-family:monospace;"><ol><li style="background: #fcfcfc;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #666666; font-style: italic;">#!/usr/bin/perl</span></div></li> <li style="background: #f0f0f0;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li> <li style="background: #fcfcfc;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #000000; font-weight: bold;">use</span> Expect<span style="color: #339933;">;</span></div></li>  <li style="background: #f0f0f0;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li> <li style="background: #fcfcfc;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><a href="http://perldoc.perl.org/functions/chdir.html"><span style="color: #000066;">chdir</span></a><span style="color: #009900;">(</span><span style="color: #ff0000;">"/files/hudson_local/jobs/MOJARRA_1_2X_ROLLING_GLASSFISH_2_1_1/workspace"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></div></li> <li style="background: #f0f0f0;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0000ff;">$ENV</span><span style="color: #009900;">{</span><span style="color: #ff0000;">"CVSROOT"</span><span style="color: #009900;">}</span> <span style="color: #339933;">=</span> <span style="color: #ff0000;">":ext:8bit@java.net/cvs/javaserverfaces-sources~cvs-repository"</span><span style="color: #339933;">;</span></div></li> <li style="background: #fcfcfc;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li> <li style="background: #f0f0f0;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #009900;">(</span><span style="color: #0000ff;">$cvs</span> <span style="color: #339933;">=</span> Expect<span style="color: #339933;">-&gt;</span><span style="color: #006600;">spawn</span><span style="color: #009900;">(</span><span style="color: #ff0000;">"cvs update -d -P"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">||</span> <a href="http://perldoc.perl.org/functions/die.html"><span style="color: #000066;">die</span></a> <span style="color: #ff0000;">"Couldn't spawn cvs, $!"</span><span style="color: #339933;">;</span></div></li>  <li style="background: #fcfcfc;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li> <li style="background: #f0f0f0;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #b1b100;">unless</span> <span style="color: #009900;">(</span><span style="color: #0000ff;">$cvs</span><span style="color: #339933;">-&gt;</span><span style="color: #006600;">expect</span><span style="color: #009900;">(</span><span style="color: #cc66cc;">30</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">"Enter passphrase for key '/files/hudson_local/.ssh/id_rsa':"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span></div></li> <li style="background: #fcfcfc;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; <a href="http://perldoc.perl.org/functions/die.html"><span style="color: #000066;">die</span></a> <span style="color: #ff0000;">"Never got the passphrase prompt"</span><span style="color: #339933;">;</span></div></li>  <li style="background: #f0f0f0;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #009900;">}</span></div></li> <li style="background: #fcfcfc;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li> <li style="background: #f0f0f0;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><a href="http://perldoc.perl.org/functions/print.html"><span style="color: #000066;">print</span></a> <span style="color: #0000ff;">$cvs</span> <span style="color: #ff0000;">"this is not the real password<span style="color: #000099; font-weight: bold;">\r</span>"</span><span style="color: #339933;">;</span></div></li> <li style="background: #fcfcfc;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li> <li style="background: #f0f0f0;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #b1b100;">unless</span> <span style="color: #009900;">(</span><span style="color: #0000ff;">$cvs</span><span style="color: #339933;">-&gt;</span><span style="color: #006600;">expect</span><span style="color: #009900;">(</span><span style="color: #cc66cc;">300</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">"cvs update: Updating www/legal/jsf-cddl"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span></div></li>  <li style="background: #fcfcfc;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp; <a href="http://perldoc.perl.org/functions/die.html"><span style="color: #000066;">die</span></a> <span style="color: #ff0000;">"Never saw update starting"</span><span style="color: #339933;">;</span></div></li> <li style="background: #f0f0f0;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #009900;">}</span></div></li> <li style="background: #fcfcfc;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li> <li style="background: #f0f0f0;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li> </ol></div>          </div>  <p>This
 enables me to quickly get the Mojarra JSF 1.2 hudson job working again 
without upgrading hudson or messing with any other configuration 
nonsense.</p>   <p><span class="technoratitag">  Technorati Tags: <a href="http://www.technorati.com/tags/edburns" rel="tag">edburns</a></span></p>
